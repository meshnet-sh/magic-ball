# Magic-Ball 开发历史记录

## 2026-02-25
- **项目构思初期**: 讨论了开发一个多功能个人工具箱的高层级(High Level)设计。
- **架构决策**:
  - 采用基座+插件(工具)架构，各工具数据完全隔离并独立路由。
  - 数据存储倾向于云端安全存储，选择 Cloudflare 生态 (Pages + D1 数据库)。
- **技术栈选型**:
  - 核心框架: Next.js (前后端一体化)
  - UI 与样式: Tailwind CSS + shadcn/ui
  - 状态管理: Zustand (本地) + SWR/React Query (数据获取)
- **环境检查与准备**:
  - `Node.js` (`v24.14.0`) 和 `npm` (`v11.9.0`) 已安装成功并可用。
- **初始化工程与 UI 设计**:
  - 初始框架搭建完成，确认了“科技暗黑风 (Geek Dark Mode)”主色调。
  - 完成了具备毛玻璃 (Glassmorphism) 特效的自适应侧边栏与主布局基座，并将界面汉化为全中文。
- **核心工具开发 - 极速闪念笔记 (Idea Logger)**:
  - 放弃原定 JSON 工具，重新架构以移动端优先 (Mobile-First) 的需求。
  - 实现了 `idb-keyval` (IndexedDB) 驱动的零延迟本地离线数据存储。
  - 实现了界面底部吸附的多媒体输入框。
  - 成功集成了 `MediaRecorder API` 支持原生麦克风语音录制存留。
  - 支持手机原生调起摄像头拍照录入。
  - 文本输入支持 `#标签` 的隐式正则提取与高亮展示。
  - 使用 `date-fns` 实现了诸如“几分钟前”的瀑布流时间组件。
- **代码审查与部署准备 (Code Review & Deployment)**:
  - 执行 `npm run lint` 和 `npm run build` 进行全局防御性静态分析，0 警告 0 报错完美通过。
  - 成功生成静态 HTML 产物，随时可以免配置推送到 Cloudflare Pages 享受全球分发。

## 2026-02-25 (补充)
- **解答数据同步问题**:
  - 用户反馈电脑端记录的闪念在手机端不可见。
  - 向用户解释了当前应用属于**纯前端单机版**架构，数据使用 `idb-keyval` 完全存储在当前设备的浏览器本地 (IndexedDB) 中。
  - 提出下一步如需实现跨端同步，需要引入用户认证(Authentication)与云端数据库(如 D1 / Supabase)。

- **跨端架构重构与云端能力接入**:
  - 用户确认采用 **全套 Cloudflare 边缘计算架构** 来实现数据同步。
  - 移除了 Next.js 的静态导出限制，引入了 `@cloudflare/next-on-pages` 以支持 Edge API 路由。
  - 设计并实施了基于 Cloudflare D1 (SQLite) 的云端数据库，通过 `drizzle-orm` 开发 Schema 管理。
  - 加入了简单的 Auth 身份验证机制，通过设置 Cookie 实现了基于用户的隐式注册与登录流程，保证了不同设备账号数据隔离。
  - 重构了前端 `useIdeasStore` (Zustand)，现在它既会把数据缓存在 IndexedDB 实现秒开，同时也会尝试与 `/api/ideas` 同步更新云数据库（增加了一个 Cloud 状态小图标）。

- **安全防御与管理员权限系统**:
  - 添加了 **白名单注册机制 (Allowlist Registration)**。公网下默认拒绝新用户凭空建立账号，仅有管理员钦定邮箱 （`meshnet@163.com`）才能触发系统数据库的新账号注册创建。其他人尝试登录会提示“私有部署拒绝注册”。
  - 为了彻底掌控本系统，开发了专门的 **上帝视角管理员控制台 (`/admin`)**。它结合了专门的 `GET /api/admin` 路由，仅验证为管理员后，方可忽略数据隔离查看 D1 数据库内全局完整的用户、内容、多媒体与发送时间元数据。
