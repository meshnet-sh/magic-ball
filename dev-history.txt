# Magic-Ball 开发历史记录

## 2026-02-25
- **项目构思初期**: 讨论了开发一个多功能个人工具箱的高层级(High Level)设计。
- **架构决策**:
  - 采用基座+插件(工具)架构，各工具数据完全隔离并独立路由。
  - 数据存储倾向于云端安全存储，选择 Cloudflare 生态 (Pages + D1 数据库)。
- **技术栈选型**:
  - 核心框架: Next.js (前后端一体化)
  - UI 与样式: Tailwind CSS + shadcn/ui
  - 状态管理: Zustand (本地) + SWR/React Query (数据获取)
- **环境检查与准备**:
  - `Node.js` (`v24.14.0`) 和 `npm` (`v11.9.0`) 已安装成功并可用。
- **初始化工程与 UI 设计**:
  - 初始框架搭建完成，确认了“科技暗黑风 (Geek Dark Mode)”主色调。
  - 完成了具备毛玻璃 (Glassmorphism) 特效的自适应侧边栏与主布局基座，并将界面汉化为全中文。
- **核心工具开发 - 极速闪念笔记 (Idea Logger)**:
  - 放弃原定 JSON 工具，重新架构以移动端优先 (Mobile-First) 的需求。
  - 实现了 `idb-keyval` (IndexedDB) 驱动的零延迟本地离线数据存储。
  - 实现了界面底部吸附的多媒体输入框。
  - 成功集成了 `MediaRecorder API` 支持原生麦克风语音录制存留。
  - 支持手机原生调起摄像头拍照录入。
  - 文本输入支持 `#标签` 的隐式正则提取与高亮展示。
  - 使用 `date-fns` 实现了诸如“几分钟前”的瀑布流时间组件。
- **代码审查与部署准备 (Code Review & Deployment)**:
  - 执行 `npm run lint` 和 `npm run build` 进行全局防御性静态分析，0 警告 0 报错完美通过。
  - 成功生成静态 HTML 产物，随时可以免配置推送到 Cloudflare Pages 享受全球分发。

## 2026-02-25 (补充)
- **解答数据同步问题**:
  - 用户反馈电脑端记录的闪念在手机端不可见。
  - 向用户解释了当前应用属于**纯前端单机版**架构，数据使用 `idb-keyval` 完全存储在当前设备的浏览器本地 (IndexedDB) 中。
  - 提出下一步如需实现跨端同步，需要引入用户认证(Authentication)与云端数据库(如 D1 / Supabase)。

- **跨端架构重构与云端能力接入**:
  - 用户确认采用 **全套 Cloudflare 边缘计算架构** 来实现数据同步。
  - 移除了 Next.js 的静态导出限制，引入了 `@cloudflare/next-on-pages` 以支持 Edge API 路由。
  - 设计并实施了基于 Cloudflare D1 (SQLite) 的云端数据库，通过 `drizzle-orm` 开发 Schema 管理。
  - 加入了简单的 Auth 身份验证机制，通过设置 Cookie 实现了基于用户的隐式注册与登录流程，保证了不同设备账号数据隔离。
  - 重构了前端 `useIdeasStore` (Zustand)，现在它既会把数据缓存在 IndexedDB 实现秒开，同时也会尝试与 `/api/ideas` 同步更新云数据库（增加了一个 Cloud 状态小图标）。

- **安全防御与管理员权限系统**:
  - 添加了 **白名单注册机制 (Allowlist Registration)**。公网下默认拒绝新用户凭空建立账号，仅有管理员钦定邮箱 （`meshnet@163.com`）才能触发系统数据库的新账号注册创建。其他人尝试登录会提示“私有部署拒绝注册”。
  - 为了彻底掌控本系统，开发了专门的 **上帝视角管理员控制台 (`/admin`)**。它结合了专门的 `GET /api/admin` 路由，仅验证为管理员后，方可忽略数据隔离查看 D1 数据库内全局完整的用户、内容、多媒体与发送时间元数据。

## 2026-02-25 ~ 2026-02-26 (部署之旅)
- **Git 仓库初始化与 GitHub 推送**:
  - 为项目初始化了 Git 仓库并推送至 GitHub (`meshnet-sh/magic-ball`)。
  - 修复了 `master` vs `main` 分支名不一致导致的 `git push` 失败。

- **Cloudflare Pages 部署 — 挫折与排障**:
  - 首次尝试通过 GitHub 连接 Cloudflare Pages 进行部署。
  - 失败1: `npm ci` 严格的对等依赖检查拒绝了 Next.js 16.x 与 `@cloudflare/next-on-pages` 的版本冲突。尝试了 `.npmrc` (legacy-peer-deps) 和 `package.json` overrides 均被 `npm ci` 忽略。
  - 最终解决: 将 Next.js 从 `16.1.6` 降级至 `15.5.2` (next-on-pages 支持的最高版本)。
  - 失败2: 部署成功但线上页面全白。排查发现远程 D1 数据库未初始化表结构，通过 `wrangler d1 execute --remote` 注入了 SQL Schema。
  - 失败3: 修复表结构后仍然 500 错误。排查发现 `bcryptjs` (Node.js 原生库) 在 Cloudflare Edge Runtime 中直接导致 Worker 初始化崩溃。用 WebCrypto API (`crypto.subtle.digest SHA-256`) 徒手重写了密码哈希。
  - 失败4: 所有 API 路由均返回 `Internal Server Error`。创建了零依赖 `/api/ping` 测试端点仍然崩溃，确认是 `@cloudflare/next-on-pages` 适配器与 Next.js 15 的根本性不兼容。

- **架构迁移 — 从 next-on-pages 到 @opennextjs/cloudflare**:
  - 彻底弃用了旧的 `@cloudflare/next-on-pages` 适配器。
  - 安装并迁移到 Cloudflare 官方最新推荐的 `@opennextjs/cloudflare` 适配器。
  - 核心变更:
    - `wrangler.toml` 重写为 Workers 格式 (main=`.open-next/worker.js`, assets=`.open-next/assets`)
    - 所有 API 路由移除 `export const runtime = 'edge'`
    - `getRequestContext()` 全部替换为 `getCloudflareContext()` (来自 `@opennextjs/cloudflare`)
    - 新增 `open-next.config.ts`, `.dev.vars`, `public/_headers`
    - `next.config.ts` 加入 `initOpenNextCloudflareForDev()`
  - 本地 `npx opennextjs-cloudflare build` 编译通过，Worker 打包成功。
  - 通过 Cloudflare Dashboard 的 Workers Git 连接完成最终部署。

- **部署结果**: 电脑端和手机端(需VPN)均可正常访问。闪念笔记登录、云端同步、管理员面板全部功能正常运行。

## 2026-02-26 (第二插件开发)
- **投票 & 意见收集器插件 (Vote & Opinion Collector)**:
  - 替换了侧边栏的"计算器"占位入口，开发了完整的投票/意见收集工具。
  - 数据库新增 3 张表: `polls`(投票主表)、`poll_options`(选项表)、`poll_responses`(响应表)。通过 `wrangler d1 execute --remote` 向线上数据库注入了 Schema。
  - 后端 API 路线:
    - `/api/polls` (GET/POST/DELETE/PATCH) — 需登录的投票 CRUD 管理
    - `/api/polls/[id]` (GET/POST) — 公开投票端点，支持访问码验证与浏览器指纹防刷
    - `/api/polls/[id]/results` (GET) — 仅投票创建者可查看的统计结果
  - 前端页面:
    - `/tools/polls` — 管理员投票管理页面（创建表单支持单选/多选/文本征集三种模式，附可选访问码、进度条结果统计、复制分享链接、开关/删除投票）
    - `/vote/[id]` — 公开投票页面（访问码门禁 → 投票表单 → 感谢页面，全程匿名无需登录）
  - 侧边栏图标改为 `Vote`（投票箱贴纸图标），指向 `/tools/polls`。

- **UI 精细化与设置页面重构**:
  - 修复了登录页面的"闪念同步"特定文字，改为通用的"登录 Magic Ball"，登录后跳转到仪表盘而非闪念笔记。
  - 使用 Next.js Route Groups 架构重构了路由体系: `/vote/[id]` 公开投票页面不再显示侧边栏和应用外壳。
  - 仪表盘计算器卡片替换为投票收集卡片，含正确链接和描述。
  - 侧边栏移除了独立"后台管理"入口，将管理功能合并到"设置"页面。
  - 全新的 **设置页面 (`/settings`)** 包含两个 Tab:
    - **AI 能力配置**: Gemini API Key 输入框（支持明文/密文切换）、模型选择器（2.0 Flash/Pro、1.5 Flash/Pro 四选一）、一键保存到云端。
    - **后台管理**: 数据总览（用户数/闪念数/投票数统计卡片），以及可折叠展开的三大板块（闪念笔记、投票活动、注册用户），覆盖全部插件数据。
  - 数据库新增 `user_settings` 表用于存储用户级配置（API Key、模型偏好等）。API 路由 `/api/settings` 支持 GET/POST 的 upsert 逻辑。

- **AI 指令中心 (AI Command Center)**:
  - Gemini 模型选择器改为 3 个动态别名: `gemini-pro-latest`(最前沿)、`gemini-flash-latest`(主力)、`gemini-flash-lite-latest`(极速)，始终自动跟随 Google 最新版本。
  - 欢迎页面新增 **AI 指令中心** 组件，支持文字和语音两种输入方式:
    - 文字输入: 直接在输入框中输入指令，回车发送
    - 语音输入: 使用 Web Speech API 进行中文语音识别，识别完成后自动发送
  - 后端新增 `/api/ai/command` 路由:
    - 读取用户在设置中配置的 Gemini API Key 和模型偏好
    - 使用包含全部插件上下文的 System Prompt 调用 Gemini API
    - 返回结构化 JSON 命令（create_idea / create_poll / navigate / chat）
  - 前端自动执行 AI 返回的命令:
    - `create_idea`: 直接调用 `/api/ideas` 创建闪念笔记
    - `create_poll`: 直接调用 `/api/polls` 创建投票
    - `navigate`: 自动跳转到目标页面
    - `chat`: 显示 AI 的对话回复

- **Bug Fix**: 闪念笔记页面客户端崩溃
  - 原因: API 返回的 `tags` 字段类型不一致 — 部分记录为 JSON 字符串 `"[]"`，部分为实际数组 `[]`，前端直接调用 `.map()` 导致崩溃。
  - 修复: 在 `ideas-store.ts` 的 `sync()` 函数中增加了 tags 类型归一化逻辑，统一解析为 `string[]`。

- **AI 指令中心升级为多轮对话模式**:
  - 后端 `/api/ai/command` 改为接收 `messages[]` 数组，发送完整对话历史给 Gemini API，支持上下文连续对话。
  - System Prompt 大幅增强: 为每个插件提供了严格的 JSON 格式规范和具体示例，包含 create_idea、create_poll(三种类型)、navigate、chat 四种命令。
  - 前端仪表盘 AI 指令中心改为聊天气泡式 UI，支持多轮对话、补充说明和上下文追问。
  - **自动重试机制**: 命令执行失败时，自动将错误信息反馈给 AI 并请求调整命令重试，最多 5 次。
  - 新增清空对话按钮。

- **语音输入修复 (弃用 Web Speech API → MediaRecorder + Gemini)**:
  - 原方案使用 Chrome 的 Web Speech API，但其依赖 Google 服务器（国内不可达），导致语音输入始终失败。
  - 新方案: 使用浏览器 MediaRecorder API 录制 webm 音频 → base64 编码 → 发送到 /api/ai/command → 作为 Gemini inlineData 音频部分发送，由 Gemini 直接理解语音内容并返回命令。
  - 整条链路通过 Cloudflare Workers 代理，绕过了国内 Google 服务不可达的问题。
  - 增加了 **静默检测自动停止**: 使用 Web Audio API 的 AnalyserNode 每 200ms 检测音量，连续 2 秒无声后自动停止录音并发送给 Gemini。

- **AI 多操作支持 & 语音转写显示**:
  - System Prompt 改为返回 `{ transcript, actions[] }` 格式，支持一次说多个任务时全部拆分执行。
  - 语音输入时，用户气泡显示 `🎤 "识别到的文字"` 以呈现上下文。
  - 前端按顺序执行 actions 数组中的所有操作，某步失败时触发自动重试。
