# Magic-Ball å¼€å‘å†å²è®°å½•

## 2026-02-25
- **é¡¹ç›®æ„æ€åˆæœŸ**: è®¨è®ºäº†å¼€å‘ä¸€ä¸ªå¤šåŠŸèƒ½ä¸ªäººå·¥å…·ç®±çš„é«˜å±‚çº§(High Level)è®¾è®¡ã€‚
- **æ¶æ„å†³ç­–**:
  - é‡‡ç”¨åŸºåº§+æ’ä»¶(å·¥å…·)æ¶æ„ï¼Œå„å·¥å…·æ•°æ®å®Œå…¨éš”ç¦»å¹¶ç‹¬ç«‹è·¯ç”±ã€‚
  - æ•°æ®å­˜å‚¨å€¾å‘äºäº‘ç«¯å®‰å…¨å­˜å‚¨ï¼Œé€‰æ‹© Cloudflare ç”Ÿæ€ (Pages + D1 æ•°æ®åº“)ã€‚
- **æŠ€æœ¯æ ˆé€‰å‹**:
  - æ ¸å¿ƒæ¡†æ¶: Next.js (å‰åç«¯ä¸€ä½“åŒ–)
  - UI ä¸æ ·å¼: Tailwind CSS + shadcn/ui
  - çŠ¶æ€ç®¡ç†: Zustand (æœ¬åœ°) + SWR/React Query (æ•°æ®è·å–)
- **ç¯å¢ƒæ£€æŸ¥ä¸å‡†å¤‡**:
  - `Node.js` (`v24.14.0`) å’Œ `npm` (`v11.9.0`) å·²å®‰è£…æˆåŠŸå¹¶å¯ç”¨ã€‚
- **åˆå§‹åŒ–å·¥ç¨‹ä¸ UI è®¾è®¡**:
  - åˆå§‹æ¡†æ¶æ­å»ºå®Œæˆï¼Œç¡®è®¤äº†â€œç§‘æŠ€æš—é»‘é£ (Geek Dark Mode)â€ä¸»è‰²è°ƒã€‚
  - å®Œæˆäº†å…·å¤‡æ¯›ç»ç’ƒ (Glassmorphism) ç‰¹æ•ˆçš„è‡ªé€‚åº”ä¾§è¾¹æ ä¸ä¸»å¸ƒå±€åŸºåº§ï¼Œå¹¶å°†ç•Œé¢æ±‰åŒ–ä¸ºå…¨ä¸­æ–‡ã€‚
- **æ ¸å¿ƒå·¥å…·å¼€å‘ - æé€Ÿé—ªå¿µç¬”è®° (Idea Logger)**:
  - æ”¾å¼ƒåŸå®š JSON å·¥å…·ï¼Œé‡æ–°æ¶æ„ä»¥ç§»åŠ¨ç«¯ä¼˜å…ˆ (Mobile-First) çš„éœ€æ±‚ã€‚
  - å®ç°äº† `idb-keyval` (IndexedDB) é©±åŠ¨çš„é›¶å»¶è¿Ÿæœ¬åœ°ç¦»çº¿æ•°æ®å­˜å‚¨ã€‚
  - å®ç°äº†ç•Œé¢åº•éƒ¨å¸é™„çš„å¤šåª’ä½“è¾“å…¥æ¡†ã€‚
  - æˆåŠŸé›†æˆäº† `MediaRecorder API` æ”¯æŒåŸç”Ÿéº¦å…‹é£è¯­éŸ³å½•åˆ¶å­˜ç•™ã€‚
  - æ”¯æŒæ‰‹æœºåŸç”Ÿè°ƒèµ·æ‘„åƒå¤´æ‹ç…§å½•å…¥ã€‚
  - æ–‡æœ¬è¾“å…¥æ”¯æŒ `#æ ‡ç­¾` çš„éšå¼æ­£åˆ™æå–ä¸é«˜äº®å±•ç¤ºã€‚
  - ä½¿ç”¨ `date-fns` å®ç°äº†è¯¸å¦‚â€œå‡ åˆ†é’Ÿå‰â€çš„ç€‘å¸ƒæµæ—¶é—´ç»„ä»¶ã€‚
- **ä»£ç å®¡æŸ¥ä¸éƒ¨ç½²å‡†å¤‡ (Code Review & Deployment)**:
  - æ‰§è¡Œ `npm run lint` å’Œ `npm run build` è¿›è¡Œå…¨å±€é˜²å¾¡æ€§é™æ€åˆ†æï¼Œ0 è­¦å‘Š 0 æŠ¥é”™å®Œç¾é€šè¿‡ã€‚
  - æˆåŠŸç”Ÿæˆé™æ€ HTML äº§ç‰©ï¼Œéšæ—¶å¯ä»¥å…é…ç½®æ¨é€åˆ° Cloudflare Pages äº«å—å…¨çƒåˆ†å‘ã€‚

## 2026-02-25 (è¡¥å……)
- **è§£ç­”æ•°æ®åŒæ­¥é—®é¢˜**:
  - ç”¨æˆ·åé¦ˆç”µè„‘ç«¯è®°å½•çš„é—ªå¿µåœ¨æ‰‹æœºç«¯ä¸å¯è§ã€‚
  - å‘ç”¨æˆ·è§£é‡Šäº†å½“å‰åº”ç”¨å±äº**çº¯å‰ç«¯å•æœºç‰ˆ**æ¶æ„ï¼Œæ•°æ®ä½¿ç”¨ `idb-keyval` å®Œå…¨å­˜å‚¨åœ¨å½“å‰è®¾å¤‡çš„æµè§ˆå™¨æœ¬åœ° (IndexedDB) ä¸­ã€‚
  - æå‡ºä¸‹ä¸€æ­¥å¦‚éœ€å®ç°è·¨ç«¯åŒæ­¥ï¼Œéœ€è¦å¼•å…¥ç”¨æˆ·è®¤è¯(Authentication)ä¸äº‘ç«¯æ•°æ®åº“(å¦‚ D1 / Supabase)ã€‚

- **è·¨ç«¯æ¶æ„é‡æ„ä¸äº‘ç«¯èƒ½åŠ›æ¥å…¥**:
  - ç”¨æˆ·ç¡®è®¤é‡‡ç”¨ **å…¨å¥— Cloudflare è¾¹ç¼˜è®¡ç®—æ¶æ„** æ¥å®ç°æ•°æ®åŒæ­¥ã€‚
  - ç§»é™¤äº† Next.js çš„é™æ€å¯¼å‡ºé™åˆ¶ï¼Œå¼•å…¥äº† `@cloudflare/next-on-pages` ä»¥æ”¯æŒ Edge API è·¯ç”±ã€‚
  - è®¾è®¡å¹¶å®æ–½äº†åŸºäº Cloudflare D1 (SQLite) çš„äº‘ç«¯æ•°æ®åº“ï¼Œé€šè¿‡ `drizzle-orm` å¼€å‘ Schema ç®¡ç†ã€‚
  - åŠ å…¥äº†ç®€å•çš„ Auth èº«ä»½éªŒè¯æœºåˆ¶ï¼Œé€šè¿‡è®¾ç½® Cookie å®ç°äº†åŸºäºç”¨æˆ·çš„éšå¼æ³¨å†Œä¸ç™»å½•æµç¨‹ï¼Œä¿è¯äº†ä¸åŒè®¾å¤‡è´¦å·æ•°æ®éš”ç¦»ã€‚
  - é‡æ„äº†å‰ç«¯ `useIdeasStore` (Zustand)ï¼Œç°åœ¨å®ƒæ—¢ä¼šæŠŠæ•°æ®ç¼“å­˜åœ¨ IndexedDB å®ç°ç§’å¼€ï¼ŒåŒæ—¶ä¹Ÿä¼šå°è¯•ä¸ `/api/ideas` åŒæ­¥æ›´æ–°äº‘æ•°æ®åº“ï¼ˆå¢åŠ äº†ä¸€ä¸ª Cloud çŠ¶æ€å°å›¾æ ‡ï¼‰ã€‚

- **å®‰å…¨é˜²å¾¡ä¸ç®¡ç†å‘˜æƒé™ç³»ç»Ÿ**:
  - æ·»åŠ äº† **ç™½åå•æ³¨å†Œæœºåˆ¶ (Allowlist Registration)**ã€‚å…¬ç½‘ä¸‹é»˜è®¤æ‹’ç»æ–°ç”¨æˆ·å‡­ç©ºå»ºç«‹è´¦å·ï¼Œä»…æœ‰ç®¡ç†å‘˜é’¦å®šé‚®ç®± ï¼ˆ`meshnet@163.com`ï¼‰æ‰èƒ½è§¦å‘ç³»ç»Ÿæ•°æ®åº“çš„æ–°è´¦å·æ³¨å†Œåˆ›å»ºã€‚å…¶ä»–äººå°è¯•ç™»å½•ä¼šæç¤ºâ€œç§æœ‰éƒ¨ç½²æ‹’ç»æ³¨å†Œâ€ã€‚
  - ä¸ºäº†å½»åº•æŒæ§æœ¬ç³»ç»Ÿï¼Œå¼€å‘äº†ä¸“é—¨çš„ **ä¸Šå¸è§†è§’ç®¡ç†å‘˜æ§åˆ¶å° (`/admin`)**ã€‚å®ƒç»“åˆäº†ä¸“é—¨çš„ `GET /api/admin` è·¯ç”±ï¼Œä»…éªŒè¯ä¸ºç®¡ç†å‘˜åï¼Œæ–¹å¯å¿½ç•¥æ•°æ®éš”ç¦»æŸ¥çœ‹ D1 æ•°æ®åº“å†…å…¨å±€å®Œæ•´çš„ç”¨æˆ·ã€å†…å®¹ã€å¤šåª’ä½“ä¸å‘é€æ—¶é—´å…ƒæ•°æ®ã€‚

## 2026-02-25 ~ 2026-02-26 (éƒ¨ç½²ä¹‹æ—…)
- **Git ä»“åº“åˆå§‹åŒ–ä¸ GitHub æ¨é€**:
  - ä¸ºé¡¹ç›®åˆå§‹åŒ–äº† Git ä»“åº“å¹¶æ¨é€è‡³ GitHub (`meshnet-sh/magic-ball`)ã€‚
  - ä¿®å¤äº† `master` vs `main` åˆ†æ”¯åä¸ä¸€è‡´å¯¼è‡´çš„ `git push` å¤±è´¥ã€‚

- **Cloudflare Pages éƒ¨ç½² â€” æŒ«æŠ˜ä¸æ’éšœ**:
  - é¦–æ¬¡å°è¯•é€šè¿‡ GitHub è¿æ¥ Cloudflare Pages è¿›è¡Œéƒ¨ç½²ã€‚
  - å¤±è´¥1: `npm ci` ä¸¥æ ¼çš„å¯¹ç­‰ä¾èµ–æ£€æŸ¥æ‹’ç»äº† Next.js 16.x ä¸ `@cloudflare/next-on-pages` çš„ç‰ˆæœ¬å†²çªã€‚å°è¯•äº† `.npmrc` (legacy-peer-deps) å’Œ `package.json` overrides å‡è¢« `npm ci` å¿½ç•¥ã€‚
  - æœ€ç»ˆè§£å†³: å°† Next.js ä» `16.1.6` é™çº§è‡³ `15.5.2` (next-on-pages æ”¯æŒçš„æœ€é«˜ç‰ˆæœ¬)ã€‚
  - å¤±è´¥2: éƒ¨ç½²æˆåŠŸä½†çº¿ä¸Šé¡µé¢å…¨ç™½ã€‚æ’æŸ¥å‘ç°è¿œç¨‹ D1 æ•°æ®åº“æœªåˆå§‹åŒ–è¡¨ç»“æ„ï¼Œé€šè¿‡ `wrangler d1 execute --remote` æ³¨å…¥äº† SQL Schemaã€‚
  - å¤±è´¥3: ä¿®å¤è¡¨ç»“æ„åä»ç„¶ 500 é”™è¯¯ã€‚æ’æŸ¥å‘ç° `bcryptjs` (Node.js åŸç”Ÿåº“) åœ¨ Cloudflare Edge Runtime ä¸­ç›´æ¥å¯¼è‡´ Worker åˆå§‹åŒ–å´©æºƒã€‚ç”¨ WebCrypto API (`crypto.subtle.digest SHA-256`) å¾’æ‰‹é‡å†™äº†å¯†ç å“ˆå¸Œã€‚
  - å¤±è´¥4: æ‰€æœ‰ API è·¯ç”±å‡è¿”å› `Internal Server Error`ã€‚åˆ›å»ºäº†é›¶ä¾èµ– `/api/ping` æµ‹è¯•ç«¯ç‚¹ä»ç„¶å´©æºƒï¼Œç¡®è®¤æ˜¯ `@cloudflare/next-on-pages` é€‚é…å™¨ä¸ Next.js 15 çš„æ ¹æœ¬æ€§ä¸å…¼å®¹ã€‚

- **æ¶æ„è¿ç§» â€” ä» next-on-pages åˆ° @opennextjs/cloudflare**:
  - å½»åº•å¼ƒç”¨äº†æ—§çš„ `@cloudflare/next-on-pages` é€‚é…å™¨ã€‚
  - å®‰è£…å¹¶è¿ç§»åˆ° Cloudflare å®˜æ–¹æœ€æ–°æ¨èçš„ `@opennextjs/cloudflare` é€‚é…å™¨ã€‚
  - æ ¸å¿ƒå˜æ›´:
    - `wrangler.toml` é‡å†™ä¸º Workers æ ¼å¼ (main=`.open-next/worker.js`, assets=`.open-next/assets`)
    - æ‰€æœ‰ API è·¯ç”±ç§»é™¤ `export const runtime = 'edge'`
    - `getRequestContext()` å…¨éƒ¨æ›¿æ¢ä¸º `getCloudflareContext()` (æ¥è‡ª `@opennextjs/cloudflare`)
    - æ–°å¢ `open-next.config.ts`, `.dev.vars`, `public/_headers`
    - `next.config.ts` åŠ å…¥ `initOpenNextCloudflareForDev()`
  - æœ¬åœ° `npx opennextjs-cloudflare build` ç¼–è¯‘é€šè¿‡ï¼ŒWorker æ‰“åŒ…æˆåŠŸã€‚
  - é€šè¿‡ Cloudflare Dashboard çš„ Workers Git è¿æ¥å®Œæˆæœ€ç»ˆéƒ¨ç½²ã€‚

- **éƒ¨ç½²ç»“æœ**: ç”µè„‘ç«¯å’Œæ‰‹æœºç«¯(éœ€VPN)å‡å¯æ­£å¸¸è®¿é—®ã€‚é—ªå¿µç¬”è®°ç™»å½•ã€äº‘ç«¯åŒæ­¥ã€ç®¡ç†å‘˜é¢æ¿å…¨éƒ¨åŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚

## 2026-02-26 (ç¬¬äºŒæ’ä»¶å¼€å‘)
- **æŠ•ç¥¨ & æ„è§æ”¶é›†å™¨æ’ä»¶ (Vote & Opinion Collector)**:
  - æ›¿æ¢äº†ä¾§è¾¹æ çš„"è®¡ç®—å™¨"å ä½å…¥å£ï¼Œå¼€å‘äº†å®Œæ•´çš„æŠ•ç¥¨/æ„è§æ”¶é›†å·¥å…·ã€‚
  - æ•°æ®åº“æ–°å¢ 3 å¼ è¡¨: `polls`(æŠ•ç¥¨ä¸»è¡¨)ã€`poll_options`(é€‰é¡¹è¡¨)ã€`poll_responses`(å“åº”è¡¨)ã€‚é€šè¿‡ `wrangler d1 execute --remote` å‘çº¿ä¸Šæ•°æ®åº“æ³¨å…¥äº† Schemaã€‚
  - åç«¯ API è·¯çº¿:
    - `/api/polls` (GET/POST/DELETE/PATCH) â€” éœ€ç™»å½•çš„æŠ•ç¥¨ CRUD ç®¡ç†
    - `/api/polls/[id]` (GET/POST) â€” å…¬å¼€æŠ•ç¥¨ç«¯ç‚¹ï¼Œæ”¯æŒè®¿é—®ç éªŒè¯ä¸æµè§ˆå™¨æŒ‡çº¹é˜²åˆ·
    - `/api/polls/[id]/results` (GET) â€” ä»…æŠ•ç¥¨åˆ›å»ºè€…å¯æŸ¥çœ‹çš„ç»Ÿè®¡ç»“æœ
  - å‰ç«¯é¡µé¢:
    - `/tools/polls` â€” ç®¡ç†å‘˜æŠ•ç¥¨ç®¡ç†é¡µé¢ï¼ˆåˆ›å»ºè¡¨å•æ”¯æŒå•é€‰/å¤šé€‰/æ–‡æœ¬å¾é›†ä¸‰ç§æ¨¡å¼ï¼Œé™„å¯é€‰è®¿é—®ç ã€è¿›åº¦æ¡ç»“æœç»Ÿè®¡ã€å¤åˆ¶åˆ†äº«é“¾æ¥ã€å¼€å…³/åˆ é™¤æŠ•ç¥¨ï¼‰
    - `/vote/[id]` â€” å…¬å¼€æŠ•ç¥¨é¡µé¢ï¼ˆè®¿é—®ç é—¨ç¦ â†’ æŠ•ç¥¨è¡¨å• â†’ æ„Ÿè°¢é¡µé¢ï¼Œå…¨ç¨‹åŒ¿åæ— éœ€ç™»å½•ï¼‰
  - ä¾§è¾¹æ å›¾æ ‡æ”¹ä¸º `Vote`ï¼ˆæŠ•ç¥¨ç®±è´´çº¸å›¾æ ‡ï¼‰ï¼ŒæŒ‡å‘ `/tools/polls`ã€‚

- **UI ç²¾ç»†åŒ–ä¸è®¾ç½®é¡µé¢é‡æ„**:
  - ä¿®å¤äº†ç™»å½•é¡µé¢çš„"é—ªå¿µåŒæ­¥"ç‰¹å®šæ–‡å­—ï¼Œæ”¹ä¸ºé€šç”¨çš„"ç™»å½• Magic Ball"ï¼Œç™»å½•åè·³è½¬åˆ°ä»ªè¡¨ç›˜è€Œéé—ªå¿µç¬”è®°ã€‚
  - ä½¿ç”¨ Next.js Route Groups æ¶æ„é‡æ„äº†è·¯ç”±ä½“ç³»: `/vote/[id]` å…¬å¼€æŠ•ç¥¨é¡µé¢ä¸å†æ˜¾ç¤ºä¾§è¾¹æ å’Œåº”ç”¨å¤–å£³ã€‚
  - ä»ªè¡¨ç›˜è®¡ç®—å™¨å¡ç‰‡æ›¿æ¢ä¸ºæŠ•ç¥¨æ”¶é›†å¡ç‰‡ï¼Œå«æ­£ç¡®é“¾æ¥å’Œæè¿°ã€‚
  - ä¾§è¾¹æ ç§»é™¤äº†ç‹¬ç«‹"åå°ç®¡ç†"å…¥å£ï¼Œå°†ç®¡ç†åŠŸèƒ½åˆå¹¶åˆ°"è®¾ç½®"é¡µé¢ã€‚
  - å…¨æ–°çš„ **è®¾ç½®é¡µé¢ (`/settings`)** åŒ…å«ä¸¤ä¸ª Tab:
    - **AI èƒ½åŠ›é…ç½®**: Gemini API Key è¾“å…¥æ¡†ï¼ˆæ”¯æŒæ˜æ–‡/å¯†æ–‡åˆ‡æ¢ï¼‰ã€æ¨¡å‹é€‰æ‹©å™¨ï¼ˆ2.0 Flash/Proã€1.5 Flash/Pro å››é€‰ä¸€ï¼‰ã€ä¸€é”®ä¿å­˜åˆ°äº‘ç«¯ã€‚
    - **åå°ç®¡ç†**: æ•°æ®æ€»è§ˆï¼ˆç”¨æˆ·æ•°/é—ªå¿µæ•°/æŠ•ç¥¨æ•°ç»Ÿè®¡å¡ç‰‡ï¼‰ï¼Œä»¥åŠå¯æŠ˜å å±•å¼€çš„ä¸‰å¤§æ¿å—ï¼ˆé—ªå¿µç¬”è®°ã€æŠ•ç¥¨æ´»åŠ¨ã€æ³¨å†Œç”¨æˆ·ï¼‰ï¼Œè¦†ç›–å…¨éƒ¨æ’ä»¶æ•°æ®ã€‚
  - æ•°æ®åº“æ–°å¢ `user_settings` è¡¨ç”¨äºå­˜å‚¨ç”¨æˆ·çº§é…ç½®ï¼ˆAPI Keyã€æ¨¡å‹åå¥½ç­‰ï¼‰ã€‚API è·¯ç”± `/api/settings` æ”¯æŒ GET/POST çš„ upsert é€»è¾‘ã€‚

- **AI æŒ‡ä»¤ä¸­å¿ƒ (AI Command Center)**:
  - Gemini æ¨¡å‹é€‰æ‹©å™¨æ”¹ä¸º 3 ä¸ªåŠ¨æ€åˆ«å: `gemini-pro-latest`(æœ€å‰æ²¿)ã€`gemini-flash-latest`(ä¸»åŠ›)ã€`gemini-flash-lite-latest`(æé€Ÿ)ï¼Œå§‹ç»ˆè‡ªåŠ¨è·Ÿéš Google æœ€æ–°ç‰ˆæœ¬ã€‚
  - æ¬¢è¿é¡µé¢æ–°å¢ **AI æŒ‡ä»¤ä¸­å¿ƒ** ç»„ä»¶ï¼Œæ”¯æŒæ–‡å­—å’Œè¯­éŸ³ä¸¤ç§è¾“å…¥æ–¹å¼:
    - æ–‡å­—è¾“å…¥: ç›´æ¥åœ¨è¾“å…¥æ¡†ä¸­è¾“å…¥æŒ‡ä»¤ï¼Œå›è½¦å‘é€
    - è¯­éŸ³è¾“å…¥: ä½¿ç”¨ Web Speech API è¿›è¡Œä¸­æ–‡è¯­éŸ³è¯†åˆ«ï¼Œè¯†åˆ«å®Œæˆåè‡ªåŠ¨å‘é€
  - åç«¯æ–°å¢ `/api/ai/command` è·¯ç”±:
    - è¯»å–ç”¨æˆ·åœ¨è®¾ç½®ä¸­é…ç½®çš„ Gemini API Key å’Œæ¨¡å‹åå¥½
    - ä½¿ç”¨åŒ…å«å…¨éƒ¨æ’ä»¶ä¸Šä¸‹æ–‡çš„ System Prompt è°ƒç”¨ Gemini API
    - è¿”å›ç»“æ„åŒ– JSON å‘½ä»¤ï¼ˆcreate_idea / create_poll / navigate / chatï¼‰
  - å‰ç«¯è‡ªåŠ¨æ‰§è¡Œ AI è¿”å›çš„å‘½ä»¤:
    - `create_idea`: ç›´æ¥è°ƒç”¨ `/api/ideas` åˆ›å»ºé—ªå¿µç¬”è®°
    - `create_poll`: ç›´æ¥è°ƒç”¨ `/api/polls` åˆ›å»ºæŠ•ç¥¨
    - `navigate`: è‡ªåŠ¨è·³è½¬åˆ°ç›®æ ‡é¡µé¢
    - `chat`: æ˜¾ç¤º AI çš„å¯¹è¯å›å¤

- **Bug Fix**: é—ªå¿µç¬”è®°é¡µé¢å®¢æˆ·ç«¯å´©æºƒ
  - åŸå› : API è¿”å›çš„ `tags` å­—æ®µç±»å‹ä¸ä¸€è‡´ â€” éƒ¨åˆ†è®°å½•ä¸º JSON å­—ç¬¦ä¸² `"[]"`ï¼Œéƒ¨åˆ†ä¸ºå®é™…æ•°ç»„ `[]`ï¼Œå‰ç«¯ç›´æ¥è°ƒç”¨ `.map()` å¯¼è‡´å´©æºƒã€‚
  - ä¿®å¤: åœ¨ `ideas-store.ts` çš„ `sync()` å‡½æ•°ä¸­å¢åŠ äº† tags ç±»å‹å½’ä¸€åŒ–é€»è¾‘ï¼Œç»Ÿä¸€è§£æä¸º `string[]`ã€‚

- **AI æŒ‡ä»¤ä¸­å¿ƒå‡çº§ä¸ºå¤šè½®å¯¹è¯æ¨¡å¼**:
  - åç«¯ `/api/ai/command` æ”¹ä¸ºæ¥æ”¶ `messages[]` æ•°ç»„ï¼Œå‘é€å®Œæ•´å¯¹è¯å†å²ç»™ Gemini APIï¼Œæ”¯æŒä¸Šä¸‹æ–‡è¿ç»­å¯¹è¯ã€‚
  - System Prompt å¤§å¹…å¢å¼º: ä¸ºæ¯ä¸ªæ’ä»¶æä¾›äº†ä¸¥æ ¼çš„ JSON æ ¼å¼è§„èŒƒå’Œå…·ä½“ç¤ºä¾‹ï¼ŒåŒ…å« create_ideaã€create_poll(ä¸‰ç§ç±»å‹)ã€navigateã€chat å››ç§å‘½ä»¤ã€‚
  - å‰ç«¯ä»ªè¡¨ç›˜ AI æŒ‡ä»¤ä¸­å¿ƒæ”¹ä¸ºèŠå¤©æ°”æ³¡å¼ UIï¼Œæ”¯æŒå¤šè½®å¯¹è¯ã€è¡¥å……è¯´æ˜å’Œä¸Šä¸‹æ–‡è¿½é—®ã€‚
  - **è‡ªåŠ¨é‡è¯•æœºåˆ¶**: å‘½ä»¤æ‰§è¡Œå¤±è´¥æ—¶ï¼Œè‡ªåŠ¨å°†é”™è¯¯ä¿¡æ¯åé¦ˆç»™ AI å¹¶è¯·æ±‚è°ƒæ•´å‘½ä»¤é‡è¯•ï¼Œæœ€å¤š 5 æ¬¡ã€‚
  - æ–°å¢æ¸…ç©ºå¯¹è¯æŒ‰é’®ã€‚

- **è¯­éŸ³è¾“å…¥ä¿®å¤ (å¼ƒç”¨ Web Speech API â†’ MediaRecorder + Gemini)**:
  - åŸæ–¹æ¡ˆä½¿ç”¨ Chrome çš„ Web Speech APIï¼Œä½†å…¶ä¾èµ– Google æœåŠ¡å™¨ï¼ˆå›½å†…ä¸å¯è¾¾ï¼‰ï¼Œå¯¼è‡´è¯­éŸ³è¾“å…¥å§‹ç»ˆå¤±è´¥ã€‚
  - æ–°æ–¹æ¡ˆ: ä½¿ç”¨æµè§ˆå™¨ MediaRecorder API å½•åˆ¶ webm éŸ³é¢‘ â†’ base64 ç¼–ç  â†’ å‘é€åˆ° /api/ai/command â†’ ä½œä¸º Gemini inlineData éŸ³é¢‘éƒ¨åˆ†å‘é€ï¼Œç”± Gemini ç›´æ¥ç†è§£è¯­éŸ³å†…å®¹å¹¶è¿”å›å‘½ä»¤ã€‚
  - æ•´æ¡é“¾è·¯é€šè¿‡ Cloudflare Workers ä»£ç†ï¼Œç»•è¿‡äº†å›½å†… Google æœåŠ¡ä¸å¯è¾¾çš„é—®é¢˜ã€‚
  - å¢åŠ äº† **é™é»˜æ£€æµ‹è‡ªåŠ¨åœæ­¢**: ä½¿ç”¨ Web Audio API çš„ AnalyserNode æ¯ 200ms æ£€æµ‹éŸ³é‡ï¼Œè¿ç»­ 2 ç§’æ— å£°åè‡ªåŠ¨åœæ­¢å½•éŸ³å¹¶å‘é€ç»™ Geminiã€‚

- **AI å¤šæ“ä½œæ”¯æŒ & è¯­éŸ³è½¬å†™æ˜¾ç¤º**:
  - System Prompt æ”¹ä¸ºè¿”å› `{ transcript, actions[] }` æ ¼å¼ï¼Œæ”¯æŒä¸€æ¬¡è¯´å¤šä¸ªä»»åŠ¡æ—¶å…¨éƒ¨æ‹†åˆ†æ‰§è¡Œã€‚
  - è¯­éŸ³è¾“å…¥æ—¶ï¼Œç”¨æˆ·æ°”æ³¡æ˜¾ç¤º `ğŸ¤ "è¯†åˆ«åˆ°çš„æ–‡å­—"` ä»¥å‘ˆç°ä¸Šä¸‹æ–‡ã€‚
  - å‰ç«¯æŒ‰é¡ºåºæ‰§è¡Œ actions æ•°ç»„ä¸­çš„æ‰€æœ‰æ“ä½œï¼ŒæŸæ­¥å¤±è´¥æ—¶è§¦å‘è‡ªåŠ¨é‡è¯•ã€‚

- **æ—¥ç¨‹è°ƒåº¦æ’ä»¶ (Scheduler)**:
  - æ–°å¢ `scheduled_tasks` è¡¨ (D1 migration 0004)ï¼Œæ”¯æŒå®šæ—¶è§¦å‘æ—¶é—´ã€é‡å¤è§„åˆ™ã€æ“ä½œç±»å‹å’Œå‚æ•°ã€‚
  - CRUD API `/api/scheduler`: åˆ›å»º/æŸ¥è¯¢/æ›´æ–°/åˆ é™¤å®šæ—¶ä»»åŠ¡ã€‚
  - è§¦å‘ API `/api/scheduler/trigger`: æ£€æŸ¥åˆ°æœŸä»»åŠ¡å¹¶è‡ªåŠ¨æ‰§è¡Œï¼ˆåˆ›å»ºç¬”è®°ã€è§¦å‘ AIã€æé†’ï¼‰ï¼Œæ”¯æŒé‡å¤ä»»åŠ¡è‡ªåŠ¨è®¡ç®—ä¸‹æ¬¡è§¦å‘æ—¶é—´ã€‚
  - AI é›†æˆ: æ–°å¢ `schedule_task`(åˆ›å»ºå®šæ—¶ä»»åŠ¡)ã€`list_tasks`(æŸ¥çœ‹ä»»åŠ¡)ã€`cancel_task`(å–æ¶ˆä»»åŠ¡) ä¸‰ä¸ª AI æŒ‡ä»¤ã€‚System Prompt æ³¨å…¥å®æ—¶æ—¶é—´æˆ³ï¼ŒAI å¯ç†è§£è‡ªç„¶è¯­è¨€æ—¶é—´ã€‚
  - å‰ç«¯ `/tools/scheduler` é¡µé¢: ä»»åŠ¡åˆ—è¡¨ã€çŠ¶æ€è¿‡æ»¤ã€æ‰‹åŠ¨åˆ›å»ºè¡¨å•ã€æš‚åœ/æ¢å¤/åˆ é™¤æ“ä½œã€‚
  - ä»ªè¡¨ç›˜: æ–°å¢æ—¥ç¨‹è°ƒåº¦å·¥å…·å¡ç‰‡ï¼Œ60 ç§’å®¢æˆ·ç«¯è½®è¯¢è‡ªåŠ¨æ£€æŸ¥åˆ°æœŸä»»åŠ¡å¹¶æ˜¾ç¤ºé€šçŸ¥ã€‚
  - ä¾§è¾¹æ æ–°å¢æ—¥ç¨‹è°ƒåº¦å¯¼èˆªå…¥å£ã€‚

---
## å¼€å‘çŸ¥è¯†å¤‡å¿˜

### D1 æ•°æ®åº“ Migrationï¼ˆè¿ç§»ï¼‰
- æ¯æ¬¡æ–°å¢éœ€è¦å­˜å‚¨æ•°æ®çš„åŠŸèƒ½æ—¶ï¼Œéœ€è¦æ‰§è¡Œä¸€æ¬¡ migrationï¼Œæœ¬è´¨å°±æ˜¯"ä¸ºæ–°åŠŸèƒ½åšæ•°æ®åº“åˆå§‹åŒ–"ã€‚
- ä»£ç ä¸­çš„ `schema.ts` åªæ˜¯å‘Šè¯‰åº”ç”¨ä»£ç æ•°æ®ç»“æ„é•¿ä»€ä¹ˆæ ·ï¼Œæ•°æ®åº“æœ¬èº«å¹¶ä¸ä¼šè‡ªåŠ¨åŒæ­¥ï¼Œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œ SQL æ¥åˆ›å»º/ä¿®æ”¹è¡¨ã€‚
- é¡¹ç›®ä¸­çš„ migration æ–‡ä»¶ (drizzle/0000~0004.sql) ä¸åŠŸèƒ½å¯¹åº”:
  - 0000 â†’ ç”¨æˆ·è¡¨ (ç™»å½•)
  - 0002 â†’ æŠ•ç¥¨ç›¸å…³è¡¨ (æŠ•ç¥¨åŠŸèƒ½)
  - 0003 â†’ ç”¨æˆ·è®¾ç½®è¡¨ (AI é…ç½®)
  - 0004 â†’ å®šæ—¶ä»»åŠ¡è¡¨ (æ—¥ç¨‹è°ƒåº¦)

### Wrangler å‘½ä»¤è¡Œå·¥å…·
- Wrangler æ˜¯ Cloudflare å®˜æ–¹ CLI å·¥å…·ï¼Œç”¨äºåœ¨æœ¬åœ°è¿œç¨‹ç®¡ç† Cloudflare æœåŠ¡ã€‚
- å·²ä½œä¸º npm ä¾èµ–å®‰è£…åœ¨é¡¹ç›®ä¸­ï¼Œé…ç½®æ–‡ä»¶ä¸º `wrangler.toml`ã€‚
- å¸¸ç”¨å‘½ä»¤:
  - `npx wrangler d1 execute <æ•°æ®åº“å> --remote --command "SQLè¯­å¥"` â€” è¿œç¨‹æ‰§è¡Œ D1 SQL
  - `npx wrangler d1 list` â€” æŸ¥çœ‹æ‰€æœ‰ D1 æ•°æ®åº“
  - `npx wrangler deploy` â€” éƒ¨ç½² Worker
  - `npx wrangler dev` â€” æœ¬åœ°å¼€å‘è°ƒè¯•
- æ³¨æ„: PowerShell ä¸‹éœ€ç¡®ä¿ Node.js åœ¨ PATH ä¸­ï¼Œå¯ç”¨ `$env:PATH += ";C:\Program Files\nodejs"` ä¸´æ—¶æ·»åŠ ã€‚

- **é£ä¹¦æœºå™¨äººæ¥å…¥ AI æŒ‡ä»¤ä¸­å¿ƒ**:
  - æ–°å¢ `src/lib/feishu.ts`: é£ä¹¦ API å·¥å…·ç±» (è·å– tenant_access_tokenã€å›å¤æ¶ˆæ¯ã€å‘é€æ¶ˆæ¯)ã€‚
  - æ–°å¢ `/api/feishu/webhook`: é£ä¹¦äº‹ä»¶å›è°ƒç«¯ç‚¹ï¼Œå¤„ç† URL éªŒè¯(challenge)ã€æ¥æ”¶æ¶ˆæ¯äº‹ä»¶(im.message.receive_v1)ã€‚
  - æ¶ˆæ¯å¤„ç†æµç¨‹: æ¥æ”¶æ–‡æœ¬ â†’ æŸ¥æ‰¾ Gemini API Key â†’ è°ƒç”¨ AI â†’ æ‰§è¡Œå‘½ä»¤(åˆ›å»ºç¬”è®°/æ—¥ç¨‹ç­‰) â†’ å›å¤é£ä¹¦ã€‚
  - æ·»åŠ  event_id å»é‡æœºåˆ¶ï¼Œé˜²æ­¢é£ä¹¦é‡è¯•å¯¼è‡´é‡å¤å›å¤ã€‚
  - é£ä¹¦é…ç½®: App ID cli_a92bd1e2eab81bc9, éœ€åœ¨é£ä¹¦å¼€æ”¾å¹³å°åˆ›å»ºä¼ä¸šè‡ªå»ºåº”ç”¨å¹¶å‘å¸ƒã€‚

- **Cloudflare Cron Worker (åå°å®šæ—¶è°ƒåº¦)**:
  - æ–°å¢ `/api/scheduler/cron`: æ—  cookie è®¤è¯çš„è§¦å‘ç«¯ç‚¹ï¼Œç”¨ secret key ä¿æŠ¤ï¼Œå¤„ç†æ‰€æœ‰ç”¨æˆ·çš„åˆ°æœŸä»»åŠ¡ã€‚
  - é£ä¹¦ webhook è‡ªåŠ¨ä¿å­˜å‘ä¿¡äºº open_id åˆ° user_settingsï¼Œä¾› cron ç«¯ç‚¹ä¸»åŠ¨æ¨é€é£ä¹¦é€šçŸ¥ã€‚
  - æ–°å¢ `cron-worker/` ç‹¬ç«‹ Cloudflare Worker: æ¯åˆ†é’Ÿé€šè¿‡ cron trigger è°ƒç”¨ /api/scheduler/cronã€‚
  - éƒ¨ç½²å‘½ä»¤: `cd cron-worker && npx wrangler deploy`ï¼Œéƒ¨ç½²ååœ¨ https://magic-ball-cron.meshnet.workers.dev å¯æ‰‹åŠ¨è§¦å‘æµ‹è¯•ã€‚
  - ä»»åŠ¡æ‰§è¡Œç»“æœé€šè¿‡é£ä¹¦ä¸»åŠ¨æ¨é€ç»™ç”¨æˆ·ï¼Œä¸ä¾èµ–ç”¨æˆ·æ‰“å¼€ç½‘é¡µã€‚

### Cloudflare Cron Worker åŸç†
- Cron Worker æ˜¯ Cloudflare çš„å®šæ—¶ä»»åŠ¡åŠŸèƒ½ï¼Œç±»ä¼¼"äº‘ç«¯é—¹é’Ÿ"ã€‚
- æ ¸å¿ƒæœºåˆ¶: Cloudflare æŒ‰ç…§ cron è¡¨è¾¾å¼(å¦‚ `* * * * *` = æ¯åˆ†é’Ÿ)è‡ªåŠ¨è°ƒç”¨ Worker çš„ `scheduled()` å‡½æ•°ã€‚
- æˆ‘ä»¬çš„ Cron Worker éå¸¸è½»é‡(cron-worker/index.js ä»…å‡ è¡Œ)ï¼Œå®ƒçš„å”¯ä¸€å·¥ä½œæ˜¯è°ƒç”¨ä¸»åº”ç”¨çš„ `/api/scheduler/cron` æ¥å£ã€‚
- çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘(æ£€æŸ¥åˆ°æœŸä»»åŠ¡ã€æ‰§è¡Œæ“ä½œã€é£ä¹¦æ¨é€)éƒ½åœ¨ä¸»åº”ç”¨ä»£ç é‡Œï¼Œé€šè¿‡ GitHub æ¨é€è‡ªåŠ¨éƒ¨ç½²ã€‚
- æ¶æ„: `Cloudflare è°ƒåº¦å™¨ â†’ Cron Worker (index.js) â†’ ä¸»åº”ç”¨ /api/scheduler/cron â†’ æ‰§è¡Œä»»åŠ¡ â†’ é£ä¹¦æ¨é€`

- **ä½•æ—¶éœ€è¦é‡æ–°éƒ¨ç½² Cron Worker**:
  - æ”¹å˜è§¦å‘é¢‘ç‡ (ä¿®æ”¹ `cron-worker/wrangler.toml` é‡Œçš„ crons)
  - ä¿®æ”¹ Cron Worker è‡ªèº«ä»£ç  (`cron-worker/index.js`)
  - ä¿®æ”¹ CRON_SECRET å¯†é’¥
  - éƒ¨ç½²å‘½ä»¤: `cd cron-worker && npx wrangler deploy`
  - æ™®é€šä¸šåŠ¡é€»è¾‘ä¿®æ”¹(å¢å‡æ’ä»¶åŠŸèƒ½ç­‰)ä¸éœ€è¦é‡æ–°éƒ¨ç½²ï¼Œä¼šéšä¸»åº”ç”¨ GitHub Push è‡ªåŠ¨ç”Ÿæ•ˆã€‚

- **Cron è¡¨è¾¾å¼é€ŸæŸ¥**:
  - `* * * * *` â€” æ¯åˆ†é’Ÿ
  - `*/5 * * * *` â€” æ¯ 5 åˆ†é’Ÿ
  - `0 * * * *` â€” æ¯å°æ—¶æ•´ç‚¹
  - `0 9 * * *` â€” æ¯å¤©æ—©ä¸Š 9 ç‚¹
  - æ ¼å¼: åˆ† æ—¶ æ—¥ æœˆ å‘¨

- **åˆ†é’Ÿçº§é‡å¤ä»»åŠ¡**:
  - æ–°å¢ `minutes:X` å’Œ `hours:X` é‡å¤è§„åˆ™ï¼Œæ”¯æŒ"æ¯5åˆ†é’Ÿæé†’æˆ‘"ç­‰åœºæ™¯ã€‚
  - æ›´æ–°äº† computeNextTrigger (trigger + cron ä¸¤å¤„)ï¼ŒAI ç³»ç»Ÿæç¤ºè¯ (web + é£ä¹¦)ï¼Œä»¥åŠè°ƒåº¦é¡µé¢ UI (ä¸‹æ‹‰é€‰é¡¹ + æ˜¾ç¤ºæ ‡ç­¾)ã€‚
  - é…åˆ Cron Worker æ¯åˆ†é’Ÿæ£€æŸ¥ï¼Œå®ç°åˆ†é’Ÿçº§ç²¾åº¦çš„è‡ªåŠ¨ä»»åŠ¡æ‰§è¡Œã€‚

- **ç»Ÿä¸€æ’ä»¶ç¼–æ’ + AI Agent + è®°å¿†ç³»ç»Ÿ**:
  - `executeAction.ts`: æ–°å¢äº†ç»Ÿä¸€æ‰§è¡Œå¼•æ“ï¼Œæ‰€æœ‰æ’ä»¶æ“ä½œï¼ˆåŒ…æ‹¬åˆ›å»ºç¬”è®°ã€å‘æé†’ã€è°ƒåº¦ä»»åŠ¡ç­‰ï¼‰ç»Ÿä¸€ç”±æ­¤å¤„ç†ã€‚
  - **AI Agent æ¨¡å¼**: åˆ›å»º `ai_agent` åŠ¨ä½œï¼Œç»“åˆè°ƒåº¦å™¨æ”¯æŒåˆ°æœŸè‡ªåŠ¨å”¤é†’AIè¿›è¡Œè‡ªä¸»å†³ç­–ï¼ˆæœ€å¤šé€’å½’3å±‚ï¼‰ï¼Œå¯ç»„æˆå¤æ‚å·¥ä½œæµã€‚
  - **è®°å¿†ç³»ç»Ÿ (`ai_memories`)**: AI ä¼šåœ¨ç”¨æˆ·å¯¹è¯åã€Agentæ‰§è¡Œåè‡ªåŠ¨å°†æ ¸å¿ƒä¿¡æ¯å½•å…¥æ•°æ®åº“ï¼›æ¯æ¬¡AIè¢«å”¤é†’æ—¶æ³¨å…¥æœ€è¿‘ç›¸å…³è®°å¿†ï¼Œæä¾›é•¿æœŸä¸Šä¸‹æ–‡è®°å¿†æ”¯æŒã€‚
  - Web AI å‘½ä»¤å’Œé£ä¹¦ Webhook äº¤äº’å¼•æ“å‡å·²é‡æ„æ¥å…¥ä¸Šè¿°æ–°æ¶æ„ã€‚

## 2026-02-27 (Bug ä¿®å¤ä¸ç»†åŒ–)
- **Bug Fix**: æŠ•ç¥¨æ— æ³•åˆ é™¤
  - ä¿®å¤: åœ¨ `src/app/api/polls/route.ts` ä¸­å°†æ‰€æœ‰çš„ `.get()` è°ƒç”¨æ›¿æ¢ä¸ºå®‰å…¨çš„æ•°ç»„ç´¢å¼• `[0]` è®¿é—®æ–¹å¼ï¼Œç¡®ä¿ç¨³å®šè¯»å–è®°å½•å¹¶é¡ºåˆ©æ‰§è¡Œåˆ é™¤æ“ä½œã€‚

- **AI å®šæœŸæ€»ç»“èŒƒå›´ä¼˜åŒ–**:
  - ç”¨æˆ·åé¦ˆ AI è¢«å®šæ—¶ä»»åŠ¡å”¤é†’åï¼Œä¼šæ€»ç»“å¤–éƒ¨ä¸–ç•Œçš„å®¢è§‚å¤§äº‹ä»¶ï¼Œè€Œä¸æ˜¯å…³æ³¨ Magic Ball è‡ªèº«ç³»ç»Ÿå†…çš„é—ªå¿µç¬”è®°ã€‚
  - ä¼˜åŒ–: åœ¨ `src/lib/executeAction.ts` ä¸­é‡å†™äº† `ai_agent` çš„ç³»ç»Ÿæç¤ºè¯ï¼Œä¸¥å‰ç¦æ­¢å…¶ä½¿ç”¨è‡ªå¸¦æ¨¡å‹çŸ¥è¯†ç¼–é€ å¤–éƒ¨æ–°é—»ï¼Œå¹¶å¼ºåŒ–å½“å‰æ—¶é—´æˆ³çš„å½±å“åŠ›ï¼Œå¼ºåˆ¶å…¶ä»…åŸºäºæä¾›çš„å±€éƒ¨å°ä¸–ç•Œä¸Šä¸‹æ–‡å›ç­”ã€‚

- **è°ƒåº¦å™¨ç¡®è®¤æœºåˆ¶ä¸é£ä¹¦æ¨é€é—­ç¯**:
  - ç”¨æˆ·åé¦ˆAIåœ¨åˆ›å»ºè°ƒåº¦ä»»åŠ¡æ—¶ç»å¸¸è‡ªä½œä¸»å¼ ï¼Œä¸”é€šè¿‡ç½‘é¡µç«¯è§¦å‘çš„è°ƒåº¦ä»»åŠ¡æ²¡æœ‰æ¨é€åˆ°é£ä¹¦ã€‚
  - ä¿®å¤1(äºŒæ¬¡ç¡®è®¤): æ›´æ–°äº† Web AI å‘½ä»¤å’Œ é£ä¹¦ webhook ä¸­ `ai_agent` çš„æç¤ºè¯ï¼Œå¼ºåˆ¶è¦æ±‚å®ƒåœ¨æ‰§è¡Œ `schedule_task` ä¹‹å‰å¿…é¡»å…ˆä½¿ç”¨ `chat` å‘ç”¨æˆ·ç¡®è®¤å…·ä½“çš„è§¦å‘æ—¶é—´å’Œç»†èŠ‚ã€‚
  - ä¿®å¤2(ç½‘é¡µç«¯è§¦å‘æ¨é€): é‡æ„äº† `src/app/api/scheduler/trigger/route.ts` å®¢æˆ·ç«¯è½®è¯¢æ‰§è¡Œé€»è¾‘ï¼Œç»Ÿä¸€å°†å…¶åº•å±‚è°ƒç”¨æ›¿æ¢ä¸º `executeAction`ï¼Œå¹¶åœ¨æ‰§è¡Œå®Œæ¯•ååƒ Cron worker ä¸€æ ·æŠŠç»“æœæ±‡æ€»æ¨é€åˆ°ç”¨æˆ·ç»‘å®šçš„ Feishu Open IDã€‚

- **Webç«¯æ¶ˆæ¯è®°å½•æŒä¹…åŒ–ä¸é£ä¹¦åŒæ­¥**:
  - ç”¨æˆ·åé¦ˆ Web ç«¯çš„æ¶ˆæ¯å¼¹æ¡†è¿‡å¿«æ¶ˆå¤±ä¸”æ— æ³•å›é¡¾ï¼Œå¹¶ä¸”å¸Œæœ›è®°å½•èƒ½åŒæ­¥ç»™é£ä¹¦ã€‚
  - æ•°æ®åº“æ¼”è¿›: å¢åŠ äº† `messages` è¡¨ç”¨äºæŒä¹…åŒ–æ‰€æœ‰çš„ç³»ç»Ÿ/AIæ¶ˆæ¯å’Œç”¨æˆ·è¾“å…¥ã€‚
  - æ¥å£æ‰©å±•: æ–°å¢äº† `src/app/api/messages/route.ts` ç”¨äºå‰åç«¯åŒæ­¥ï¼Œä¸”å¦‚æœåœ¨åç«¯ä¿å­˜æ¶ˆæ¯æ—¶æ£€æµ‹åˆ°äº†AI/Systemå‘å‡ºçš„å†…å®¹ï¼Œä¼šè‡ªåŠ¨å‘ç”¨æˆ·çš„ Feishu Open ID å‘é€æ— æ„ŸçŸ¥çš„åŒæ­¥æ¨é€ã€‚
  - UIæ”¹è¿›: Webç«¯çš„èŠå¤©è®°å½•ä¼šåœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨ä» `/api/messages` æ‹‰å–ä»è€Œå®ç°å†å²é©»ç•™ã€‚

- **é£ä¹¦æœºå™¨äººé‡å¤å›å¤ Bug ä¿®å¤**:
  - æ ¹å› åˆ†æ: Cloudflare Worker ç­‰ Serverless ç¯å¢ƒåœ¨å¤„ç† webhook æ—¶ï¼Œå¦‚æœAIè¯·æ±‚è€—æ—¶è¶…è¿‡3ç§’ï¼Œé£ä¹¦ä¼šè‡ªåŠ¨é‡è¯•è§¦å‘æœºåˆ¶ï¼Œå¯¼è‡´åŒä¸€ä¸ªäº‹ä»¶è¢«å¤šæ¬¡å¤„ç†å¹¶å“åº”ã€‚ä¹‹å‰çš„å†…å­˜ `Set` æ–¹æ¡ˆç”±äºè·¨å®ä¾‹éš”ç¦»ï¼Œèµ·ä¸åˆ°å»é‡ä½œç”¨ã€‚
  - æ•°æ®åº“æ¼”è¿›: æ–°å¢äº† `feishu_events` è¡¨å¹¶é€šè¿‡ event_id åšä¸»é”®ã€‚
  - ä¿®å¤æ–¹æ¡ˆ: åœ¨ `src/app/api/feishu/webhook/route.ts` ç¬¬ä¸€æ­¥ç›´æ¥åˆ©ç”¨ sqlite çš„ `UNIQUE constraint failed` æŠ¥é”™å¼‚å¸¸æ¥è¿›è¡ŒåŸå­çš„å¹¶å‘å®‰å…¨å»é‡ã€‚

- **åˆ›å»ºå®šæ—¶ä»»åŠ¡ä¼ å‚ Error ä¿®å¤**:
  - é—®é¢˜ç°è±¡: åœ¨ Web AI æŒ‡ä»¤ä¸­å¿ƒç¡®è®¤åˆ›å»ºæé†’åï¼Œç•Œé¢æŠ›å‡ºæ•°æ®åº“æ’å…¥é”™è¯¯ï¼Œæç¤º `action_type` å­—æ®µä¸º nullã€‚
  - æ ¹å› åˆ†æ: å‰ç«¯çš„è§£æå™¨é”™è¯¯åœ°ä½¿ç”¨äº†è€æ—§çš„ `cmd.taskAction`ï¼Œè€Œæ–°çš„ AI Agent è§„èŒƒè¿”å›çš„æ½œå¥—å¯¹è±¡æ˜¯ `scheduledAction` å¯¼è‡´ `actionType` æ²¡æœ‰æ­£ç¡®æå–ã€‚åŒæ—¶å‘ç°é£ä¹¦ webhook è°ƒç”¨åˆ° `executeAction.ts` æ—¶ä¹Ÿæ¼æ‰äº† `schedule_task` çš„åˆ†æ”¯æ”¯æŒã€‚
  - ä¿®å¤æ–¹æ¡ˆ: æ›´æ–°äº† `page.tsx` ä¸­å¯¹ `scheduledAction` çš„æ­£ç¡®æ‹†è§£æ˜ å°„ï¼›å¹¶åœ¨ `executeAction.ts` è¡¥å……äº† `schedule_task` å­˜å…¥æ•°æ®åº“çš„é€»è¾‘ã€‚

- **å¤šé¡¹æ ¸å¿ƒä½“éªŒä¸ Bug ä¿®å¤å‡çº§ (2026-02-28)**:
  - æ—¶åŒºç»Ÿä¸€é—®é¢˜: ä»¥å‰ç«¯ç½‘é¡µ `new Date()` ä¾èµ–ç¯å¢ƒç³»ç»Ÿä¸” AI API åœ¨æ— æ—¶åŒºè¯´æ˜æƒ…å†µä¸‹é»˜è®¤ä½¿ç”¨ UTC(é›¶æ—¶åŒº) ä¸ºæ ¹å› ï¼Œåˆ†åˆ«ç»™ Web UI (`zh-CN` + `Asia/Shanghai`) ä¸ `route.ts` æç¤ºè¯ (æ³¨å…¥ `UTC+8`) åŠ ä¸Šå¼ºåˆ¶åŒ—äº¬æ—¶é—´çš„å£°æ˜ï¼Œç¡®ä¿æ—¥æœŸæ˜¾ç¤ºä¸æ¨æ–­å…¨åŸŸæ‹‰é½ã€‚
  - æŠ•ç¥¨åˆ é™¤æ— ååº”Bug: æŠ•ç¥¨é¡µé¢çš„åˆ é™¤æŒ‰é’®åŸå…ˆè¿ç»­åˆ†æ­¥å‘å‡ºäº†ä¸‰æ¡å•ç‹¬çš„ `delete` è¯­å¥è¿›è¡Œçº§è”åˆ é™¤ï¼ˆresponses -> options -> pollsï¼‰ã€‚åœ¨ D1 ç¯å¢ƒæˆ–ç½‘ç»œæŠ–åŠ¨æ—¶ææ˜“äº§ç”Ÿæ‚¬æŒ‚çš„ Promise è¿›è€Œå¡æ­»ã€‚å°†å…¶é‡æ„ä¿®æ”¹ä¸ºåŸå­çš„ `db.batch()` æ‰¹é‡æ‰§è¡Œï¼Œå¹¶å¢åŠ äº†å¼¹æ¡†æ•è·æŠ›å‡ºåº•å±‚çš„ Sqlite Errorã€‚
  - å®šæ—¶è°ƒåº¦æ“ä½œå‡è´Ÿ: é™ä½äº† AI Agent çš„å®‰å…¨é˜²å¾¡é˜ˆå€¼ï¼Œé€šè¿‡ä¿®æ”¹ `command/route.ts` è§„åˆ™å‘Šè¯‰ AI â€œåªè¦æ„å›¾æ˜ç¡®å°±ç›´æ¥æ’æœŸæ‰§è¡Œå¹¶è¿”å›å•è¡Œç¡®è®¤ï¼Œä¸éœ€è¦å†æŠ›é—®é¢˜é—®ç”¨æˆ·æ˜¯å¦ç¡®è®¤â€ã€‚
  - é£ä¹¦æ”¯æŒæŠ•ç¥¨å‘èµ·: ä¸ºæ ¸å¿ƒçš„æœºå™¨å¤§è„‘ `executeAction.ts` è¿½åŠ å®ç°äº† `create_poll` è§£æèƒ½åŠ›ã€‚ç°åœ¨ç”¨æˆ·åªéœ€è¦åœ¨é£ä¹¦å‘ä¸€å¥â€œå‘¨äº”å»å“ªç©â€ï¼Œä¸ä»…æ•°æ®åº“ä¼šè‡ªåŠ¨åˆ›å»ºæŠ•ç¥¨åˆ—ï¼Œè¿˜ä¼šé€šè¿‡æœºå™¨äººç›´æ¥å›ä¼ ä¸€ä¸ªå¯ä»¥ç‚¹å‡»åˆ†äº«åœ¨ç¾¤é‡Œçš„æŠ•ç¥¨çŸ­è¿æ¥ã€‚

- **å®‰å…¨æ€§ã€é˜²å¾¡æ€§ç¼–ç¨‹ä¸æ•°æ®é˜²æ‚£ (2026-02-28)**:
  - æ ¸å¿ƒæ¶æ„: æ–°å¢äº† `src/lib/auth.ts` é›†ä¸­å¤„ç†å¯†ç å­¦é€»è¾‘ã€‚
  - è¶Šæƒç™»å½•ä¸ä¼ªé€ ä¼šè¯å°å µ: ç§»é™¤äº†åŸæ¥åŸºäºå•çº¯éšæœº UUID ä¸”æ˜æ–‡å­˜æ”¾åœ¨ Cookie ä¸­çš„è„†å¼±å‡­è¯æœºåˆ¶ã€‚æ¥å…¥äº†åŸºäº Server ç‹¬ç«‹å¯†é’¥çš„ WebCrypto HMAC `signUserId` å’Œ `verifyAndExtractUserId`ã€‚ç°åœ¨æ‰€æœ‰çš„ /api ä¸‹åŒ…å«ç”¨æˆ·é‰´æƒçš„ 12 ä¸ªè·¯ç”±éƒ½è¢«é‡æ„ä¸ºä»…ä¿¡ä»»æ ¡éªŒè¿‡æ•°å­—ç­¾åçš„ Cookieã€‚
  - é˜²å¾¡è¶ŠæƒæŠ•ç¥¨ä¸æ•°æ®è„ä¹± (BAC): `api/polls/[id]/route.ts` åŸæœ¬æ¥æ”¶ä»»ä½•æ¥æºçš„é€‰é¡¹ ID å¹¶æ— è„‘æ’å…¥ï¼Œå¯¼è‡´æ½œåœ¨å¹½çµé€‰é¡¹å †ç§¯ã€‚ç°åœ¨ä¼šåœ¨å…¥åº“å‰å»æ•°æ®åº“äºŒæ¬¡æ‹‰å–æ¯”å¯¹å½“å‰ ID æ‰€åœ¨çš„æ¯é—®é¢˜åˆæ³•é€‰é¡¹ï¼Œå¦‚æœå¯¹ä¸ä¸Šæˆ–è€…æ•…æ„ä¼ ç©ºæ•°ç»„ï¼Œç›´æ¥æ‹’ç»æœåŠ¡ã€‚
  - æŠ•ç¥¨é˜²æ°´å†›è„šæœ¬ (Rate Limit) ä½“ç³»: ç”±äºä¹‹å‰æŠ•ç¥¨é˜²åˆ·ä»…ä¾èµ–å‰ç«¯æŒ‡çº¹å®¹æ˜“è¢«ä¼ªé€ ï¼Œç°å‡çº§ä¸ºå°† Cloudflare Worker å±‚çš„ `cf-connecting-ip` åŠ ä¸ŠåŸç”Ÿæ€å‰ç«¯ Fingerprintï¼Œå¹¶åŠ ç›è¿›è¡Œ SHA256 å¤åˆå“ˆå¸Œã€‚è¿™ä¸ª `secureFingerprint` å¤§å¤§æå‡äº†æœºåˆ·çš„ä½œæ¶æˆæœ¬ã€‚
  - é˜² 500 æ–­è·¯å™¨ (Input Validation): åœ¨ `ideas` ä¸ `scheduler` åˆ›å»ºæ¥å£å‰ç½®äº†åŸºäº typeof ä¸å¿…å¡«å­—æ®µéªŒè¯çš„ 400 é˜²å¾¡æ‹¦æˆªï¼Œé˜²æ­¢è„æ•°æ®ç›´æ¥å¯¼è‡´åº•å±‚ SQLite çº¦æŸå´©æºƒå¡æ­»ã€‚
  - ç»Ÿä¸€åˆ é™¤ç¡®è®¤æµ: å¯¹â€œé—ªå¿µç¬”è®°â€ä¸â€œè°ƒåº¦å™¨â€ä¸­çš„åˆ é™¤äº¤äº’è¿›è¡Œäº†ç»Ÿä¸€åˆ‡æ¢ï¼Œä»å¯èƒ½è¢«æµè§ˆå™¨æ‚„æ‚„æ‹¦æˆªçš„ `window.confirm` åŸç”Ÿå¼¹æ¡†ï¼Œç»Ÿä¸€å‡çº§åˆ°äº†åŸåœ°çš„ React State â€œç¡®è®¤åˆ é™¤ï¼Ÿæ˜¯/å¦â€ å†…è”æ¸²æŸ“ä½“éªŒï¼Œå¹¶çº æ­£äº†é£ä¹¦ webhook é‡Œçš„å‡åŸŸåé”™åˆ«å­—ã€‚

- **å¤šæ¨¡æ€èƒ½åŠ›å‡çº§ (2026-02-28 è¡¥å……)**:
  - é£ä¹¦å•ä¿¡æºå¯Œåª’ä½“ (è¯­éŸ³ä¸å›¾ç‰‡): åœ¨ `lib/feishu.ts` ä¸­æ–°å¢äº†åº•å±‚çš„ `downloadResource` å·¥å…·ä»¥æŠ“å–é£ä¹¦ç”¨æˆ·çš„ç§èŠå¯Œåª’ä½“é™„ä»¶ã€‚åŒæ—¶åœ¨ `api/feishu/webhook/route.ts` æ”¾å¼€äº†å¯¹ `image` åŠ `audio` æ¶ˆæ¯ç±»å‹çš„æ‹¦æˆªï¼Œå°†å…¶äºŒè¿›åˆ¶ Buffer è½¬ä½œ base64 `inlineData` å–‚ç»™åå°åº•å±‚çš„ Gemini 2.0 åŸç”Ÿå¤šæ¨¡æ€è§£æå†…æ ¸ã€‚å¹¶åœ¨ä¼ ç»™å¤§æ¨¡å‹å‰æ™ºèƒ½æ¨ç®—å¹¶å¼ºåˆ¶å…¼å®¹ ogg/opus è¯­éŸ³å®¹å™¨ã€‚
  - é£ä¹¦ç»„åˆå‹å¯Œæ–‡æœ¬ (`post`) æ”¯æŒ: ç”±äºåœ¨ç§»åŠ¨ç«¯å‘é€å¤šé€‰å†…å®¹çš„ç»„åˆç»“æ„ï¼Œæˆ–è€…ç”µè„‘ç«¯å‘é€å›¾æ–‡æ··æ’ï¼Œé£ä¹¦åå°å‡è§£æä¸º `post` æ”¶ä»¶ç±»å‹ã€‚ç°å·²å…¨é¢æ”¯æŒå¤šå…ƒç´ éå†å’Œå¹¶è¡Œèµ„æºæ‹‰å–ï¼Œæå–å¯Œæ–‡æœ¬æ ‘ä¸­çš„æ¯ä¸€æ®µ `text`ã€`img` å’Œ `media` (å½•éŸ³) å¹¶æ‰“åŒ…åˆå¹¶æˆåŒ…å«å›¾ç‰‡ã€å½•éŸ³åŠæ–‡å­—çš„å¤šæ¨¡æ€åˆé›†å†æ‰”ç»™ Geminiã€‚çœŸæ­£å®ç°äº†éšå¿ƒæ‰€æ¬²æ— ç¼ææ„å›¾ã€‚

### 2026-02-28: Multi-Tenant Architecture & Feishu Open ID Binding
- User Registration: Removed the `meshnet@163.com` hardcoded lock in `/api/auth/route.ts` to allow open registration for all visitors, officially moving from a single-user private instance to a multi-tenant platform.
- Admin Roles & Settings: Defined `meshnet@163.com` as the sole platform Admin. In `/api/settings/route.ts` and the frontend `SettingsPage`, standard users are BLOCKED from viewing or modifying global system variables (like `gemini_api_key`). They can only edit personal settings (like UI timezone, Model Preference, or Feishu Open ID).
- Multi-User Feishu Bot Routing: Rewrote the Feishu Webhook (`/api/feishu/webhook/route.ts`). Instead of blindly assigning messages to the first user with an API key, it now extracts the sender's `open_id`. It queries the `user_settings` table to dynamically find the correct `userId`. If a user is unregistered or unbound, the bot now replies dynamically with their `open_id` and instructions to bind it via the Web UI.
- API Key Proxy (Billing): Standard users and background crons (`executeAction.ts`) no longer need their own `gemini_api_key`. The backend now automatically borrows the Admin's (`meshnet@163.com`) API key to process their AI inferences, creating a centralized billing/usage pool while keeping personal data (ideas/polls/memories) strictly sandboxed per user workspace.

- Logout & User Switching: Added a DELETE /api/auth endpoint to destroy the uth_session cookie and a 'LogOut' button to the Sidebar component, allowing the admin to sign out and test the new open registration flow as a standard user.

- Authentication UI Overhaul (Login/Register/Reset): Removed the implicit 'magic' login system. Registration now requires an explicit toggle and validation against the mandatory 'meshnet' invitation code. Login errors explicitly differentiate between wrong password and unregistered email.
- Password Reset Architecture: Created a secure backend flow for password resets. Admins can click 'Request Password Reset' next to any user in the dashboard, setting a database flag. Upon their next login attempt, the user is intercepted and forced to enter a new password to overwrite their hash and clear the flag.

- Mobile UI Optimization: Added extra bottom padding to the main layout to prevent mobile browser navigation bar overlap. Simplified dashboard tool cards by hiding descriptions on small screens and significantly enlarged the AI Command Center and Fast Idea Logger interactive buttons (especially the microphone recording button) for better touch usability.

- Dashboard Expansion: Added two new modules to the main Dashboard screen. 1) 'External API Interfaces' (Íâ²¿¹¦ÄÜ½Ó¿Ú) as a placeholder for future webhooks and API gateways. 2) 'Usage Guide' (Ê¹ÓÃ°ïÖú) which links to a detailed, fully-styled Chinese documentation page explaining the system architecture, AI tools, Voice Feishu integration, Polls, and Cron job limits.

- Navigation Synergy: Synchronized the main Dashboard grid and the lateral Sidebar to feature the exact same six menu items in the same logical order (Dashboard, Ideas, Polls, Scheduler, External APIs, Settings, Help). This resolves navigational discrepancies and establishes a coordinated user experience across both interfaces.
