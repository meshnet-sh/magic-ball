# Magic Ball 开发历史记录 (Magic Ball Development History)

本文档记录了 Magic Ball 项目的关键开发里程碑和功能演进。

---

### 2026-03-01: 会话管理、全局配置与 UI 品牌化
- **全局 LLM 配置**: 强制所有用户使用管理员（meshnet@163.com）配置的 Gemini API Key 和模型，移除了普通用户的 LLM 设置项，确保后端调用的统一性。
- **全新极简对话 UI**: 实现了全屏极简聊天界面，引入了侧边栏导航，优化了移动端适配，并隐藏了工具卡片描述以提升触控体验。
- **会话历史与管理**: 
  - 修复了会话历史列表由于 SQL 映射不准导致为空的 Bug，实现了更稳健的会话聚合查询（基于内存过滤最新消息）。
  - 增加了“新建对话”功能，确保当前对话状态能无缝存入历史并开启新会话。
  - 增加了会话删除功能，支持在历史列表中通过垃圾桶图标清理旧对话。
- **系统品牌统一**: 将所有界面中的 'Dashboard' (仪表盘) 统一重命名为 'Magic Ball'，强化了品牌一致性。
- **自动化集成增强**: 
  - 完善了 n8n Webhook 的 inbound 逻辑，确保来自 n8n 的消息能正确关联用户并持久化。
  - 增强了 Action 执行引擎（executeAction.ts）的鲁棒性，增加了用户存在性校验。
  - 实现了定时任务执行报告实时同步到网页端聊天记录的功能。

### 2026-02-28: n8n 自动化深度集成与 API 开放
- **外接工作流 (Outbound)**: 在 AI 指令集中加入了 `trigger_external_workflow` 能力，支持 AI 助手直接触发 n8n 等外部自动化平台。
- **入站 Webhook (Inbound)**: 建立了 `/api/webhooks/n8n/[userId]` 路由，支持外部系统向指定用户发送系统通知或 AI 回复，并支持消息持久化。
- **邮件发送标准**: 强制要求 AI 在发送邮件任务时采用标准的 JSON 结构（to, subject, body），以便 n8n 节点精准解析。
- **多租户策略**: 调整了 n8n 集成策略，支持用户动态配置自己的 n8n Webhook URL 和 Token。
- **导航同步**: 同步了侧边栏和主页网格的菜单项（闪念笔记、投票收集、日程调度、外部 API、系统设置、使用帮助），确保体验的一致性。

---

*注意：此文件采用 UTF-8 BOM 编码，以确保在 Windows 环境下不出现乱码。*
