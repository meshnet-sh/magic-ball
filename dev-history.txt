# Magic-Ball 开发历史记录

## 2026-02-25
- **项目构思初期**: 讨论了开发一个多功能个人工具箱的高层级(High Level)设计。
- **架构决策**:
  - 采用基座+插件(工具)架构，各工具数据完全隔离并独立路由。
  - 数据存储倾向于云端安全存储，选择 Cloudflare 生态 (Pages + D1 数据库)。
- **技术栈选型**:
  - 核心框架: Next.js (前后端一体化)
  - UI 与样式: Tailwind CSS + shadcn/ui
  - 状态管理: Zustand (本地) + SWR/React Query (数据获取)
- **环境检查与准备**:
  - `Node.js` (`v24.14.0`) 和 `npm` (`v11.9.0`) 已安装成功并可用。
- **初始化工程与 UI 设计**:
  - 初始框架搭建完成，确认了“科技暗黑风 (Geek Dark Mode)”主色调。
  - 完成了具备毛玻璃 (Glassmorphism) 特效的自适应侧边栏与主布局基座，并将界面汉化为全中文。
- **核心工具开发 - 极速闪念笔记 (Idea Logger)**:
  - 放弃原定 JSON 工具，重新架构以移动端优先 (Mobile-First) 的需求。
  - 实现了 `idb-keyval` (IndexedDB) 驱动的零延迟本地离线数据存储。
  - 实现了界面底部吸附的多媒体输入框。
  - 成功集成了 `MediaRecorder API` 支持原生麦克风语音录制存留。
  - 支持手机原生调起摄像头拍照录入。
  - 文本输入支持 `#标签` 的隐式正则提取与高亮展示。
  - 使用 `date-fns` 实现了诸如“几分钟前”的瀑布流时间组件。
- **代码审查与部署准备 (Code Review & Deployment)**:
  - 执行 `npm run lint` 和 `npm run build` 进行全局防御性静态分析，0 警告 0 报错完美通过。
  - 成功生成静态 HTML 产物，随时可以免配置推送到 Cloudflare Pages 享受全球分发。

## 2026-02-25 (补充)
- **解答数据同步问题**:
  - 用户反馈电脑端记录的闪念在手机端不可见。
  - 向用户解释了当前应用属于**纯前端单机版**架构，数据使用 `idb-keyval` 完全存储在当前设备的浏览器本地 (IndexedDB) 中。
  - 提出下一步如需实现跨端同步，需要引入用户认证(Authentication)与云端数据库(如 D1 / Supabase)。

- **跨端架构重构与云端能力接入**:
  - 用户确认采用 **全套 Cloudflare 边缘计算架构** 来实现数据同步。
  - 移除了 Next.js 的静态导出限制，引入了 `@cloudflare/next-on-pages` 以支持 Edge API 路由。
  - 设计并实施了基于 Cloudflare D1 (SQLite) 的云端数据库，通过 `drizzle-orm` 开发 Schema 管理。
  - 加入了简单的 Auth 身份验证机制，通过设置 Cookie 实现了基于用户的隐式注册与登录流程，保证了不同设备账号数据隔离。
  - 重构了前端 `useIdeasStore` (Zustand)，现在它既会把数据缓存在 IndexedDB 实现秒开，同时也会尝试与 `/api/ideas` 同步更新云数据库（增加了一个 Cloud 状态小图标）。

- **安全防御与管理员权限系统**:
  - 添加了 **白名单注册机制 (Allowlist Registration)**。公网下默认拒绝新用户凭空建立账号，仅有管理员钦定邮箱 （`meshnet@163.com`）才能触发系统数据库的新账号注册创建。其他人尝试登录会提示“私有部署拒绝注册”。
  - 为了彻底掌控本系统，开发了专门的 **上帝视角管理员控制台 (`/admin`)**。它结合了专门的 `GET /api/admin` 路由，仅验证为管理员后，方可忽略数据隔离查看 D1 数据库内全局完整的用户、内容、多媒体与发送时间元数据。

## 2026-02-25 ~ 2026-02-26 (部署之旅)
- **Git 仓库初始化与 GitHub 推送**:
  - 为项目初始化了 Git 仓库并推送至 GitHub (`meshnet-sh/magic-ball`)。
  - 修复了 `master` vs `main` 分支名不一致导致的 `git push` 失败。

- **Cloudflare Pages 部署 — 挫折与排障**:
  - 首次尝试通过 GitHub 连接 Cloudflare Pages 进行部署。
  - 失败1: `npm ci` 严格的对等依赖检查拒绝了 Next.js 16.x 与 `@cloudflare/next-on-pages` 的版本冲突。尝试了 `.npmrc` (legacy-peer-deps) 和 `package.json` overrides 均被 `npm ci` 忽略。
  - 最终解决: 将 Next.js 从 `16.1.6` 降级至 `15.5.2` (next-on-pages 支持的最高版本)。
  - 失败2: 部署成功但线上页面全白。排查发现远程 D1 数据库未初始化表结构，通过 `wrangler d1 execute --remote` 注入了 SQL Schema。
  - 失败3: 修复表结构后仍然 500 错误。排查发现 `bcryptjs` (Node.js 原生库) 在 Cloudflare Edge Runtime 中直接导致 Worker 初始化崩溃。用 WebCrypto API (`crypto.subtle.digest SHA-256`) 徒手重写了密码哈希。
  - 失败4: 所有 API 路由均返回 `Internal Server Error`。创建了零依赖 `/api/ping` 测试端点仍然崩溃，确认是 `@cloudflare/next-on-pages` 适配器与 Next.js 15 的根本性不兼容。

- **架构迁移 — 从 next-on-pages 到 @opennextjs/cloudflare**:
  - 彻底弃用了旧的 `@cloudflare/next-on-pages` 适配器。
  - 安装并迁移到 Cloudflare 官方最新推荐的 `@opennextjs/cloudflare` 适配器。
  - 核心变更:
    - `wrangler.toml` 重写为 Workers 格式 (main=`.open-next/worker.js`, assets=`.open-next/assets`)
    - 所有 API 路由移除 `export const runtime = 'edge'`
    - `getRequestContext()` 全部替换为 `getCloudflareContext()` (来自 `@opennextjs/cloudflare`)
    - 新增 `open-next.config.ts`, `.dev.vars`, `public/_headers`
    - `next.config.ts` 加入 `initOpenNextCloudflareForDev()`
  - 本地 `npx opennextjs-cloudflare build` 编译通过，Worker 打包成功。
  - 通过 Cloudflare Dashboard 的 Workers Git 连接完成最终部署。

- **部署结果**: 电脑端和手机端(需VPN)均可正常访问。闪念笔记登录、云端同步、管理员面板全部功能正常运行。
